<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8"/>
<title>Timer</title>
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    display: flex;
    min-height: 100vh;
    flex-direction: column;
}

.menu-items {
    margin-left: 10px;
}


#menu {
    color: #fff;
    background-color: #5995DA;  /* Blue */
    padding: 5px 10px;
    display: flex;
    justify-content: space-between;
}

#links {
    display: flex;
    justify-content: flex-end;
}


#title {
    color: #5995DA;
    background-color: #D6E9FE;
    display: flex;
    font-size: 1.5em;
    color: black;
    justify-content: center;
}

#content {
    display: flex;
    flex-direction: column;
    text-align: center;
}

#display-container {
    display: flex;
    justify-content: center;
}

#display {
    padding: 10px;
    width: 550px;
    margin: 5px;
}

.display-item {
    font-size: 2.5em;
    text-align: center;
    justify-content: center;
}


#control-panel-container {
    display: flex;
    justify-content: center;
}

#control-panel {
    width: 550px;
    border: thin solid #000000;
    margin: 5px;
    padding: 5px;
}

#input-area {
    margin: 5px;
}

#control-container {
    display: flex;
    align-items: stretch;
    justify-content: space-around;
}

.control-box {
    border: thin solid #aaaaaa;
    padding: 10px;
    margin: 10px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

#checkbox-container {
    display: flex;
    justify-content: space-around;
}

.control-button {
    margin: 5px;
    padding: 5px;
}

#footer {
    display:flex;
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    flex: 1;
    background-color: #D6E9FE;
    padding: 15px;
}

.footer-item{
    flex: 1;
}

#error-msg {
    color: #FF0000;
    text-align: center;
}

#copyright {
    text-align: right;
}
</style>

<script>
/* Triggers the callback function to update the countdown */
var COUNTDOWN_CLOCK;

/* Check if we have already parsed the countdown set */
var STARTED = false;

/* The parsed countdown set */
var COUNTDOWN_SET;

/* The current segment - which segment are we on?  */
var SEG_NUM;

/* The remaining time for this segment */
var SEG_REM_TIME;

/* Whether the timer is highlighted */
var HIGHLIGHT = false;

/* The time after which the timer is highlighted */
var HIGHLIGHT_START = 5;

/* The total remaining time for this countdown session */

/* -------------- Shortcut function -------------- */
function set_bg_color(id, color) {
    document.getElementById(id).style.backgroundColor = color;
}

function set_disabled(id, s) {
    document.getElementById(id).disabled = s;
}

function set_font_color(id, color) {
    document.getElementById(id).style.color = color;
}

function write_str(id, str) {
    document.getElementById(id).textContent = str;
}

function write_html(id, str) {
    document.getElementById(id).innerHTML = str;
}

function show_element(id, s) {
    if (s) {
        document.getElementById(id).style.display = "initial";
    } else {
        document.getElementById(id).style.display = "none";
    }
}

function checkbox_toggle_display(ce, id) {
    show_element(id, document.getElementById(ce).checked);
}

/* --------------- Display related functions -------------- */
function set_display_border(s) {
    if (s) {
        document.getElementById("display").style.border = "thin solid #000000";
    } else {
        document.getElementById("display").style.border = "";
    }
}

function set_highlight(s) {
    if (s) {
        set_bg_color("seg-time", "yellow");
        HIGHLIGHT = true;
    } else {
        set_bg_color("seg-time", "initial");
        HIGHLIGHT = false;
    }
}

function update_display(time, text) {
    write_str("seg-text", text);
    if (time < HIGHLIGHT_START) {
        if (!HIGHLIGHT) {
            set_highlight(true);
        } else {
            set_highlight(false);
        }
    } else {
        set_highlight(false);
    }
    var time_str = sec_to_time_str(time);
    write_str("seg-time", time_str);
    document.title = time_str;
}

function clear_display() {
    write_str("seg-text", "");
    write_str("seg-time", "");
    set_display_border(false);
    write_str("error-msg", "");
}

/*------------------- Audio functions -----------------*/
function set_audio() {
    audio_elem = document.getElementById("audio-element");
    audio_src = document.getElementById("audio-source");
    audio_src.src = document.getElementById("audio-selector").value;
    audio_elem.load();
    play_audio();
}

function play_audio() {
    audio_elem = document.getElementById("audio-element");
    audio_elem.play();
    setTimeout(stop_audio, 2000);

}

function stop_audio() {
    audio_elem = document.getElementById("audio-element");
    audio_elem.pause();
    audio_elem.load();
}

/*-------------------- Utility functions --------------------*/
function sec_to_time_str(time) {
    var min = Math.floor(time / 60);
    var sec = time % 60;
    var min_str = min.toString();
    var sec_str = sec.toString();
    if (min < 10) {
        min_str = "0" + min_str;
    }
    if (sec < 10) {
        sec_str = "0" + sec_str;
    }
    var time_str = min_str + ":" + sec_str;
    return time_str;
}

/* Tokenise the input text */
function parse_input() {
    var input_area = document.getElementById("input-area");
    var str = input_area.value.trim();
    /* Split the input string to lines */
    var arr = str.split(/\r|\r\n|\n/);
    /* The total time */
    var total = 0;
    /* Split each line into fields */
    for (let i = 0; i < arr.length; i++) {
        arr[i] = arr[i].split(";");
        /* Split the first field into times */
        let time_arr = arr[i][0].split(":");
        /* Explicitly convert string into int */
        time_arr[0] = parseInt(time_arr[0]);
        time_arr[1] = parseInt(time_arr[1]);
        /* Check if the conversion had been valid */
        if (isNaN(time_arr[0]) || isNaN(time_arr[1])) {
            write_html("status-box", "<p>Error at:</p>" +
                 "<p>Line " + (i + 1) + "</p>");
            set_font_color("status-box", "red");
            set_disabled("start-button", true);
            COUNTDOWN_SET = [];
            return;
        } else {
            /* Calculate the segment run-time in seconds */
            arr[i][0] = (time_arr[0] * 60 + time_arr[1]);
            /* Add to the total time */
            total += arr[i][0];
        }
    }
    /* Calculate the total time, if the array is not empty*/
    if (arr.length > 0) {
        write_html("status-box", "<p>Total time:</p> <p>" +
            sec_to_time_str(total) + "</p>");
        set_font_color("status-box", "initial");
    }
    set_disabled("start-button", false);
    COUNTDOWN_SET = arr;
    return;
}

/* --------------- Timer callback functions --------------- */
function countdown_callback() {
    if (!STARTED) {
        write_str("error-msg",
        "countdown_callback(): STARTED == false");
        throw "countdown_callback(): STARTED == false";
        return;
    }
    /* If we have reached the end of this segment */
    if (SEG_REM_TIME < 0) {
        /* Play a sound, if the audio checkbox is checked */
        if(document.getElementById("audio-checkbox").checked) {
            play_audio();
        }
        SEG_NUM++;
        /* If this segment is longer than the array length */
        if (SEG_NUM >= COUNTDOWN_SET.length) {
            /* if we the loop checkbox is not checked */
            if(!document.getElementById("loop-checkbox").checked) {
                reset_timer();
                set_display_border(true)
                update_display(0, "That's it, well done! ðŸ˜Š");
                set_bg_color("seg-text", "yellow");
                return;
            }
            SEG_NUM = 0;
        }
        SEG_REM_TIME = COUNTDOWN_SET[SEG_NUM][0];
    }
    /* update display, decrease the counter */
    update_display(SEG_REM_TIME, COUNTDOWN_SET[SEG_NUM][1]);
    SEG_REM_TIME--;
    COUNTDOWN_CLOCK = setTimeout(countdown_callback, 1000);
}

function wall_clock_callback() {
    var t = new Date();
    write_str("current-time", "Current Time: " +
                t.toLocaleTimeString("en-GB"));
    setTimeout(wall_clock_callback, 500);
}

/* ----------------- Button functions ------------------ */
function start_timer() {
    /* Parse the input text box, if we haven"t. */
    if (!STARTED) {
        /* Clear error messages */
        write_str("error-msg", "");
        STARTED = true;
        SEG_NUM = 0;
        SEG_REM_TIME = COUNTDOWN_SET[0][0];
        set_disabled("input-area", true);
        set_display_border(true);
        set_bg_color("seg-text", "initial");
    }
    set_disabled("pause-button", false);
    set_disabled("start-button", true);
    /* Trigger the timer */
    countdown_callback();
}

function pause_timer() {
    clearTimeout(COUNTDOWN_CLOCK);
    set_disabled("pause-button", true);
    set_disabled("start-button", false);
}

function reset_timer() {
    set_disabled("input-area", false);
    clearTimeout(COUNTDOWN_CLOCK);
    STARTED = false;
    clear_display();
}

/* ----------------- Startup functions ------------------ */
function startup() {
    wall_clock_callback();
    checkbox_toggle_display('audio-checkbox', 'audio-control');
    set_audio();
    document.addEventListener('keyup', parse_input);
    set_disabled("pause-button", true);
    parse_input();
}

</script>

</head>

<body onload="startup()">

    <div id="menu">

    <div id="links">
<!--        <div class="menu-items">Login</div>
        <div class="menu-items">Sign Up</div>
        <div class="menu-items">Help</div>
        <div class="menu-items">About</div>
-->
    </div>

    <div id="current-time">Please turn on Javascript.</div>

    </div>

<div id="title">
    Advanced Programmable Countdown Timer
</div>

<div id="content">
    <div id="display-container">
    <div id="display">
        <div class="display-item" id="seg-text"></div>
        <div class="display-item" id="seg-time"></div>
    </div>
    </div>

    <div id="control-panel-container">
    <div id="control-panel">
        <form>
            <div>
                <label for="input-area">
                Please type what you need to countdown below:
                </label>
            </div>
            <div>
                <textarea
                    id="input-area"
                    name="input-area"
                    onchange="parse_input()"
                    cols="60"
                    rows="15"
                    placeholder="Format:
mm:ss; text string 1
mm:ss; text string 2
where mm is the minute, ss is the second.">
00:10; Interval segment text 1
1:10; Interval segment text 2
</textarea>
            </div>
            <div id="control-container">
                <div class="control-box" id="primary-control">
                    <div>
                        <button
                            id="start-button"
                            type="button"
                            onclick="start_timer()"
                            class="control-button">
                            Start
                        </button>
                        <button
                            id="pause-button"
                            type="button"
                            onclick="pause_timer()"
                            class="control-button">
                            Pause
                        </button>
                        <button
                            id="reset-button"
                            type="button"
                            onclick="reset_timer()"
                            class="control-button">
                            Reset
                        </button>
                    </div>
                    <div id="checkbox-container">
                        <div title="Tick this box if you want the timer to automatically restart when it ends.">
                            loop:
                            <input type="checkbox" id="loop-checkbox"
                            name="loop-checkbox" value="true">
                        </div>
                        <div title="Tick this box if you want a sound to be played after each segment.">
                            sound:
                            <input type="checkbox" id="audio-checkbox"
                                name="audio-checkbox" value="true" checked="true"
                                onchange="checkbox_toggle_display('audio-checkbox', 'audio-control')">
                        </div>
                    </div>
                </div>
                <div class="control-box" id="audio-control">
                        <p>Select a sound: </p>
                        <select id="audio-selector" onchange="set_audio()">
                            <option
                                value="Eas Beep-SoundBible.com-238025417.mp3">
                                EAS Beep
                            </option>
                            <option
                                value="54047__guitarguy1985__buzzer.wav">
                                Buzzer
                            </option>
                            <option
                                selected
                                value="pissed_off_duck-Mike_Koenig-1752213564.wav">
                                Duck
                            </option>
                            <option
                                value="Rooster-SoundBible.com-1114473528.wav">
                                Rooster
                            </option>
                        </select>
                        <audio id="audio-element">
                            <source id="audio-source" src=""></source>
                        </audio>
                </div>
                <div class="control-box" id="status-box">
                    <p>Total time:</p>
                    <p>00:00</p>
                </div>
            </div>
        </form>
    </div>
    </div>
</div>

<div id="footer">
    <div class="footer-item"></div>
    <div class="footer-item" id="error-msg"></div>
    <div class="footer-item" id="copyright">
    Created by Fufu Fang, fangfufu@fangfufu.co.uk
    </div>
</div>

</body>

</html>
